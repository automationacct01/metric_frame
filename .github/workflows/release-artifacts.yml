name: Generate Release Artifacts

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate artifacts for'
        required: true
        default: 'latest'

jobs:
  generate-checksums:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate checksums for source files
        run: |
          # Generate checksums for key files
          sha256sum docker-compose.prod.yml > checksums.sha256
          sha256sum install.sh >> checksums.sha256
          sha256sum quickstart.sh >> checksums.sha256

          echo "Generated checksums:"
          cat checksums.sha256

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksums.sha256

      - name: Commit checksums to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add checksums.sha256
          git diff --staged --quiet || git commit -m "Update checksums for release"
          git push origin HEAD:main || echo "Nothing to push"

  generate-docker-tarball:
    runs-on: ubuntu-latest
    needs: generate-checksums
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and save Docker images
        run: |
          VERSION="${{ github.event.inputs.version || 'latest' }}"

          # Pull the images
          docker pull ghcr.io/automationacct01/metric_frame/frontend:${VERSION} || docker pull ghcr.io/automationacct01/metric_frame/frontend:latest
          docker pull ghcr.io/automationacct01/metric_frame/backend:${VERSION} || docker pull ghcr.io/automationacct01/metric_frame/backend:latest

          # Tag for offline bundle
          docker tag ghcr.io/automationacct01/metric_frame/frontend:latest metricframe-frontend:latest
          docker tag ghcr.io/automationacct01/metric_frame/backend:latest metricframe-backend:latest

          # Save to tarball
          docker save metricframe-frontend:latest metricframe-backend:latest | gzip > metricframe-docker-images.tar.gz

          # Generate checksum
          sha256sum metricframe-docker-images.tar.gz > metricframe-docker-images.tar.gz.sha256

          echo "=== Tarball Info ==="
          ls -lh metricframe-docker-images.tar.gz
          cat metricframe-docker-images.tar.gz.sha256

      - name: Create offline install bundle
        run: |
          mkdir -p metricframe-offline

          # Copy necessary files
          cp metricframe-docker-images.tar.gz metricframe-offline/
          cp docker-compose.prod.yml metricframe-offline/docker-compose.yml
          cp install.sh metricframe-offline/

          # Create offline install script
          cat > metricframe-offline/install-offline.sh << 'OFFLINE_EOF'
#!/bin/bash
# MetricFrame Offline Installer
# Use this when you don't have internet access on the target machine

set -euo pipefail

echo "============================================"
echo "  MetricFrame Offline Installer"
echo "============================================"
echo ""

# Check for Docker
if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed."
    exit 1
fi

if ! docker info &> /dev/null 2>&1; then
    echo "Error: Docker daemon is not running."
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="${METRICFRAME_HOME:-$HOME/metricframe}"

echo "Loading Docker images from tarball..."
echo "This may take a few minutes..."

# Verify checksum if sha256sum available
if [ -f "$SCRIPT_DIR/metricframe-docker-images.tar.gz.sha256" ]; then
    echo "Verifying tarball integrity..."
    cd "$SCRIPT_DIR"
    if command -v sha256sum &> /dev/null; then
        sha256sum -c metricframe-docker-images.tar.gz.sha256
    elif command -v shasum &> /dev/null; then
        shasum -a 256 -c metricframe-docker-images.tar.gz.sha256
    fi
    cd - > /dev/null
fi

# Load images
gunzip -c "$SCRIPT_DIR/metricframe-docker-images.tar.gz" | docker load

echo ""
echo "Images loaded successfully!"

# Set up installation directory
mkdir -p "$INSTALL_DIR"
cp "$SCRIPT_DIR/docker-compose.yml" "$INSTALL_DIR/"

# Create .env if not exists
if [ ! -f "$INSTALL_DIR/.env" ]; then
    cat > "$INSTALL_DIR/.env" << 'ENV_EOF'
POSTGRES_USER=metricframe
POSTGRES_PASSWORD=metricframe_offline
POSTGRES_DB=metricframe
FRONTEND_PORT=3000
ENV_EOF
fi

cd "$INSTALL_DIR"
docker compose up -d

echo ""
echo "============================================"
echo "  MetricFrame is starting!"
echo "============================================"
echo ""
echo "  Open your browser to: http://localhost:3000"
echo ""
OFFLINE_EOF

          chmod +x metricframe-offline/install-offline.sh

          # Create the bundle
          tar -czvf metricframe-offline-bundle.tar.gz metricframe-offline/
          sha256sum metricframe-offline-bundle.tar.gz > metricframe-offline-bundle.tar.gz.sha256

          echo "=== Offline Bundle Info ==="
          ls -lh metricframe-offline-bundle.tar.gz
          cat metricframe-offline-bundle.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-offline-bundle
          path: |
            metricframe-docker-images.tar.gz
            metricframe-docker-images.tar.gz.sha256
            metricframe-offline-bundle.tar.gz
            metricframe-offline-bundle.tar.gz.sha256

      - name: Add to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            metricframe-docker-images.tar.gz
            metricframe-docker-images.tar.gz.sha256
            metricframe-offline-bundle.tar.gz
            metricframe-offline-bundle.tar.gz.sha256
            checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
